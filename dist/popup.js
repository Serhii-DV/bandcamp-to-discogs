(()=>{"use strict";const e=[];for(let t=0;t<256;++t)e.push((t+256).toString(16).slice(1));const t=/^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i,n=function(e){if(!function(e){return"string"==typeof e&&t.test(e)}(e))throw TypeError("Invalid UUID");let n;const r=new Uint8Array(16);return r[0]=(n=parseInt(e.slice(0,8),16))>>>24,r[1]=n>>>16&255,r[2]=n>>>8&255,r[3]=255&n,r[4]=(n=parseInt(e.slice(9,13),16))>>>8,r[5]=255&n,r[6]=(n=parseInt(e.slice(14,18),16))>>>8,r[7]=255&n,r[8]=(n=parseInt(e.slice(19,23),16))>>>8,r[9]=255&n,r[10]=(n=parseInt(e.slice(24,36),16))/1099511627776&255,r[11]=n/4294967296&255,r[12]=n>>>24&255,r[13]=n>>>16&255,r[14]=n>>>8&255,r[15]=255&n,r};function r(e,t,n,r){switch(e){case 0:return t&n^~t&r;case 1:case 3:return t^n^r;case 2:return t&n^t&r^n&r}}function s(e,t){return e<<t|e>>>32-t}const a=function(t,a,o){function i(t,a,o,i){var c;if("string"==typeof t&&(t=function(e){e=unescape(encodeURIComponent(e));const t=[];for(let n=0;n<e.length;++n)t.push(e.charCodeAt(n));return t}(t)),"string"==typeof a&&(a=n(a)),16!==(null===(c=a)||void 0===c?void 0:c.length))throw TypeError("Namespace must be array-like (16 iterable integer values, 0-255)");let l=new Uint8Array(16+t.length);if(l.set(a),l.set(t,a.length),l=function(e){const t=[1518500249,1859775393,2400959708,3395469782],n=[1732584193,4023233417,2562383102,271733878,3285377520];if("string"==typeof e){const t=unescape(encodeURIComponent(e));e=[];for(let n=0;n<t.length;++n)e.push(t.charCodeAt(n))}else Array.isArray(e)||(e=Array.prototype.slice.call(e));e.push(128);const a=e.length/4+2,o=Math.ceil(a/16),i=new Array(o);for(let t=0;t<o;++t){const n=new Uint32Array(16);for(let r=0;r<16;++r)n[r]=e[64*t+4*r]<<24|e[64*t+4*r+1]<<16|e[64*t+4*r+2]<<8|e[64*t+4*r+3];i[t]=n}i[o-1][14]=8*(e.length-1)/Math.pow(2,32),i[o-1][14]=Math.floor(i[o-1][14]),i[o-1][15]=8*(e.length-1)&4294967295;for(let e=0;e<o;++e){const a=new Uint32Array(80);for(let t=0;t<16;++t)a[t]=i[e][t];for(let e=16;e<80;++e)a[e]=s(a[e-3]^a[e-8]^a[e-14]^a[e-16],1);let o=n[0],c=n[1],l=n[2],u=n[3],d=n[4];for(let e=0;e<80;++e){const n=Math.floor(e/20),i=s(o,5)+r(n,c,l,u)+d+t[n]+a[e]>>>0;d=u,u=l,l=s(c,30)>>>0,c=o,o=i}n[0]=n[0]+o>>>0,n[1]=n[1]+c>>>0,n[2]=n[2]+l>>>0,n[3]=n[3]+u>>>0,n[4]=n[4]+d>>>0}return[n[0]>>24&255,n[0]>>16&255,n[0]>>8&255,255&n[0],n[1]>>24&255,n[1]>>16&255,n[1]>>8&255,255&n[1],n[2]>>24&255,n[2]>>16&255,n[2]>>8&255,255&n[2],n[3]>>24&255,n[3]>>16&255,n[3]>>8&255,255&n[3],n[4]>>24&255,n[4]>>16&255,n[4]>>8&255,255&n[4]]}(l),l[6]=15&l[6]|80,l[8]=63&l[8]|128,o){i=i||0;for(let e=0;e<16;++e)o[i+e]=l[e];return o}return function(t,n=0){return e[t[n+0]]+e[t[n+1]]+e[t[n+2]]+e[t[n+3]]+"-"+e[t[n+4]]+e[t[n+5]]+"-"+e[t[n+6]]+e[t[n+7]]+"-"+e[t[n+8]]+e[t[n+9]]+"-"+e[t[n+10]]+e[t[n+11]]+e[t[n+12]]+e[t[n+13]]+e[t[n+14]]+e[t[n+15]]}(l)}try{i.name="v5"}catch(e){}return i.DNS="6ba7b810-9dad-11d1-80b4-00c04fd430c8",i.URL="6ba7b811-9dad-11d1-80b4-00c04fd430c8",i}();function o(e){return a(e,a.URL)}class i{#e;#t;#n;constructor(e,t,n){this.#e=e,this.#t=t,this.#n=n}get value(){return this.toString()}get date(){return this.toDate()}toString(){return new Intl.DateTimeFormat("en",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"}).format(this.toDate())}toDate(){const e=new Date(0);return e.setHours(this.#e),e.setMinutes(this.#t),e.setSeconds(this.#n),e}static fromString(e){if(!/^([01]\d|2[0-3]):([0-5]\d):([0-5]\d)$/.test(e))throw new Error("Invalid time format. Please use HH:MM:SS.");const[t,n,r]=e.split(":");return new i(parseInt(t,10),parseInt(n,10),parseInt(r,10))}static fromDuration(e){const t=(/(\d+)H/.exec(e)||[])[1]||0,n=(/(\d+)M/.exec(e)||[])[1]||0,r=(/(\d+)S/.exec(e)||[])[1]||0;return new i(parseInt(t,10),parseInt(n,10),parseInt(r,10))}}const c=i;class l{constructor(e,t,n){this.url=e,this.artist=t,this.title=n,this.uuid=o(e)}static fromObject(e){return new l(e.url,e.artist,e.title)}}class u{releaseItem;label;published;modified;tracks;tracksQty;image;keywords;constructor(e,t,n,r,s,a,o,i,c){this.releaseItem=new l(o,e,t),this.label=n,this.published=r,this.modified=s,this.tracks=a,this.tracksQty=a.length,this.image=i,this.keywords=c}get artist(){return this.releaseItem.artist}get url(){return this.releaseItem.url}get title(){return this.releaseItem.title}toStorageObject(){return{uuid:this.releaseItem.uuid,artist:this.releaseItem.artist,title:this.releaseItem.title,url:this.releaseItem.url,label:this.label,published:this.published.toISOString(),modified:this.modified.toISOString(),tracks:this.tracks.map((e=>e.toStorageObject())),image:this.image,keywords:this.keywords}}static fromStorageObject(e){if(!e.url||!e.tracks)throw new Error("Cannot create Release object from object",e);const t=e.tracks.map((e=>d.fromStorageObject(e)));if(!e.published&&!e.date)throw new Error("Missing published or date property");if(!e.modified&&!e.date)throw new Error("Missing published or date property");return new u(e.artist,e.title,e.label,new Date(e.published??e.date),new Date(e.modified??e.date),t,e.url,e.image,e.keywords)}}class d{num;title;time;constructor(e,t,n){this.num=e,this.title=t,this.time=n}toStorageObject(){return{num:this.num,title:this.title,time:this.time.value}}static fromStorageObject(e){return new d(e.num,e.title,c.fromString(e.time||e.duration))}}const h={Ё:"YO",Й:"I",Ц:"TS",У:"U",К:"K",Е:"E",Н:"N",Г:"G",Ш:"SH",Щ:"SCH",З:"Z",Х:"H",Ъ:"'",ё:"yo",й:"i",ц:"ts",у:"u",к:"k",е:"e",н:"n",г:"g",ш:"sh",щ:"sch",з:"z",х:"h",ъ:"'",Ф:"F",Ы:"I",В:"V",А:"A",П:"P",Р:"R",О:"O",Л:"L",Д:"D",Ж:"ZH",Э:"E",ф:"f",ы:"i",в:"v",а:"a",п:"p",р:"r",о:"o",л:"l",д:"d",ж:"zh",э:"e",Я:"Ya",Ч:"CH",С:"S",М:"M",И:"I",Т:"T",Ь:"'",Б:"B",Ю:"YU",я:"ya",ч:"ch",с:"s",м:"m",и:"i",т:"t",ь:"'",б:"b",ю:"yu"};function m(e){return e.split(" ").map((e=>`${e.charAt(0).toUpperCase()}${e.slice(1)}`)).join(" ")}function f(e){return"string"==typeof e}function p(e){return"[object Object]"===Object.prototype.toString.call(e)}function g(e){return Array.isArray(e)}function b(e){return"function"==typeof e}function y(e){return!g(e)||0===e.length}function S(e){return[].concat(...e)}function w(e){return[...new Set(S(e))]}function k(e,t){for(const n in t)t.hasOwnProperty(n)&&(e=e.replace(`{${n}}`,t[n]));return e}function v(e){return e.replace(/^(:|0)*/,"")}async function E(e){let t={active:!0,currentWindow:!0},[n]=b(e)?await chrome.tabs.query(t,e):await chrome.tabs.query(t);return n}function I(){return chrome.runtime.getManifest()}const C=(e,t)=>{E().then((n=>{n&&chrome.tabs.sendMessage(n.id,e,t)}))};let L={};async function x(e){return fetch(e).then((e=>e.json())).then((e=>(L=e,L))).catch((e=>{L={}}))}let A={};function B(){return A=function(e){for(const t in e)if(e.hasOwnProperty(t))return!1;return!0}(A)?function(e){const t={};for(const n in e)if(e.hasOwnProperty(n)){const r=e[n];""!==r&&(t[n]=f(r)?new D(r):r)}return t}(M):A}class D{constructor(e){this.style=e,this._genre=null}get genre(){return this._genre=p(this._genre)?this._genre:(e=this.style,function(e,t){for(const n in e)if(e.hasOwnProperty(n)&&e[n].includes(t))return n;return null}(L,e));var e}}let M={};async function $(e){return fetch(e).then((e=>e.json())).then((e=>(M=e,M))).catch((e=>{M={}}))}const O={genres_url:"../data/discogs_genres.json",keyword_mapping_url:"https://gist.githubusercontent.com/Serhii-DV/44181f307548aabac2703147d3c730ba/raw/mapping.json",about_url:"../data/about.html",extension_url:"https://chrome.google.com/webstore/detail/bandcamp-to-discogs-b2d/hipnkehalkffbdjnbbeoefmoondaciok",discogs_search_artist_url:"https://www.discogs.com/search?q={artist}&type=artist",discogs_search_release_url:"https://www.discogs.com/search?q={artist}+{release}&type=release",text:{notes:"This draft was created via CSV upload and Bandcamp To Discogs Google Chrome extension {extension_url}\n\nRelease url: {release_url}"},discogsApi:{consumerKey:"TJGtBNerXwCzYvFCQXSD"}};function T(e){const t=B(),n=e.toLowerCase();if(n in t){const e=t[n];if(e instanceof D)return[e.genre];if(g(e))return q(e);if(f(e))return T(e)}return[]}function j(e){const t=B(),n=e.toLowerCase();if(n in t){const e=t[n];if(e instanceof D)return[e.style];if(g(e))return _(e);if(f(e))return j(e)}return[]}function q(e){return w(e.map(T))}function _(e){return w(e.map(j))}const R=e=>e.toISOString().split("T")[0];function H(e){return N.fromRelease(e)}function U(e,t){return k(O.discogs_search_release_url,{artist:encodeURIComponent(e),release:encodeURIComponent(t)})}class P{version;artist;title;label;format;country;released;tracklist;credits;genres;submissionNotes;constructor({artist:e,title:t,label:n,trackQty:r,formatFileType:s,formatDescription:a,country:o,released:i,tracklist:c,credits:l,genres:u,releaseUrl:d}){const h=this,m=I();h.version=m.version,h.artist=e,h.title=t,h.label=n,h.format={fileType:s,qty:r,description:a},h.country=o,h.released=i,h.tracklist=c,h.credits=l,h.genres=u,h.submissionNotes=function(e){return k(O.text.notes,{extension_url:O.extension_url,release_url:e})}(d)}static fromRelease(e){const t=R(e.published),n=R(e.modified),r=q(e.keywords),s=_(e.keywords);return new P({artist:e.releaseItem.artist,title:e.releaseItem.title,label:e.label,released:{publishedDate:t,modifiedDate:n},trackQty:e.tracksQty,formatFileType:"FLAC",formatDescription:"Album",genres:{keywords:e.keywords,autoDetectedGenres:r,autoDetectedStyles:s},releaseUrl:e.url})}}class N{constructor({artist:e,title:t,label:n,catno:r,format:s,genres:a,styles:o,tracks:i,notes:c,date:l,images:u}){this.artist=e,this.title=t,this.label=n,this.catno=r,this.format=s,this.genres=a,this.styles=o,this.tracks=i,this.notes=c,this.date=l,this.images=u}static fromRelease(e){const t=e.artist===e.label?`Not On Label (${e.artist} Self-released)`:e.label,n=P.fromRelease(e);return new N({artist:e.releaseItem.artist,title:e.releaseItem.title,label:t,catno:"none",format:"File",genres:q(e.keywords),styles:_(e.keywords),tracks:e.tracks,notes:JSON.stringify(n),date:e.published,images:e.image})}addGenre(e){return this.genres.push(e),this}addStyle(e){return this.styles.push(e),this}addTrack(e){return this.tracks.push(e),this}getGenre(){return this.genres.filter((e=>"Folk, World, & Country"!==e)).join(", ")}getStyle(){return this.styles.join(", ")}getDate(){return R(this.date)}toCsvObject(){const e=this.tracks.map((e=>`${m(e.title)} ${v(e.time.value)}`)).join("\r"),t=this.notes?this.notes.replace(/"/g,'""'):"";return{artist:`"${this.artist}"`,title:`"${m(this.title)}"`,label:`"${this.label}"`,catno:this.catno,format:this.format,genre:`"${this.getGenre()}"`,style:`"${this.getStyle()}"`,tracks:`"${e}"`,notes:`"${t}"`,date:this.getDate(),images:this.images}}}function z(e,t){return e.hasAttribute(`data-${t}`)}function V(e,t,n=""){if(p(t)){const n=t;for(const t in n)n.hasOwnProperty(t)&&V(e,t,n[t])}else e.setAttribute(`data-${t}`,n)}function F(e,t,n=void 0){return z(e,t)?e.getAttribute(`data-${t}`):n}function G(...e){e.forEach((e=>g(e)?G(...e):e.classList.remove("visually-hidden")))}function Q(...e){e.forEach((e=>g(e)?Q(...e):e.classList.add("visually-hidden")))}function Y(...e){e.forEach((e=>g(e)?Y(...e):e.disabled=!0))}function J(...e){e.forEach((e=>g(e)?J(...e):e.disabled=!1))}function K(e){var t=new MouseEvent("click",{bubbles:!0,cancelable:!0,view:window});return e.dispatchEvent(t),e}function Z(e,t){return f(t)?(e.value!==t&&(e.value=t,W(e)),e):(W(e),e)}function W(e){return e.dispatchEvent(new Event("input")),e}function X(e){const t=document.createElement("div");return t.innerHTML=e.trim(),t.firstChild}const ee=({className:e="icon-link",href:t="#",onClick:n,title:r="",iconDefault:s,iconOnClick:a,iconOnClickTimeout:o=3e3})=>{const i=document.createElement("a");return i.classList.add(e),i.title=r,i.href=t,i.target="_blank",i.innerHTML=`<b2d-icon name="${s}"></b2d-icon>`,b(n)&&i.addEventListener("click",(e=>{e.preventDefault();const t=n(e);if(a){const e=i.querySelector("b2d-icon");e.setIcon(a),setTimeout((()=>{e.setIcon(s)}),o)}return t})),i};class te extends HTMLElement{constructor(){super();const e=this;e.stateButtons=[],e.statusElements=[];const t=e.getPrefixed("selectAllCheckbox"),n=e.getPrefixed("searchInput"),r=e.getPrefixed("sorting"),s=document.createElement("template");s.innerHTML=`\n        <div class="content-header input-group input-group-sm sticky-top">\n          <input type="text" id="${n}" class="form-control form-control-sm" placeholder="Search...">\n          <button id="clear-search-button" type="button" class="btn" title="Clear search">\n            <b2d-icon name="x-circle"></b2d-icon>\n          </button>\n          <div class="control-buttons btn-group btn-group-sm" role="group" aria-label="Control buttons">\n          </div>\n          <button id="${r}-button" class="btn btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" title="Sorted by default">\n            <b2d-icon name="sort-down"></b2d-icon>\n          </button>\n          <ul id="${r}" class="dropdown-menu dropdown-menu-end">\n            <li><a class="dropdown-item" href="#" data-attr="data-sort" data-comp-type="int" data-dir="asc" data-icon="sort-down" data-title="Sorted by default"><b2d-icon name="sort-down"></b2d-icon> reset</a></li>\n            <li><hr class="dropdown-divider"></li>\n            <li><a class="dropdown-item" href="#" data-attr="data-title" data-dir="asc" data-icon="sort-alpha-down" data-title="Sorted by name A..z"><b2d-icon name="sort-alpha-down"></b2d-icon> by name A..z</a></li>\n            <li><a class="dropdown-item" href="#" data-attr="data-title" data-dir="desc" data-icon="sort-alpha-down-alt" data-title="Sorted by name z..A"><b2d-icon name="sort-alpha-down-alt"></b2d-icon> by name z..A</a></li>\n          </ul>\n        </div>\n        <table class="table table-hover table-sm table-transparent table-borderless">\n          <thead>\n            <tr>\n              <th><input type="checkbox" id="${t}" title="Select all"></th>\n              <th>\n                <label for="${t}">\n                  <span id="${t}-info" class="selected-info">Releases</span>\n                </label>\n              </th>\n            </tr>\n          </thead>\n          <tbody>\n          </tbody>\n        </table>\n    `,e.appendChild(s.content.cloneNode(!0));const a=e.querySelector("#"+t);a.addEventListener("change",(()=>{e.selectAllCheckboxes(a.checked)}));const o=e.querySelector(".table");o.addEventListener("change",(t=>{const n=t.target;"checkbox"===n.type&&e.selectCheckbox(n,n.checked).refreshStatus()})),e.searchInput=document.getElementById(n),e.searchInput.addEventListener("input",(function(){const t=e.searchInput.value.toLowerCase();o.querySelectorAll("tbody tr").forEach((e=>{const n=e.querySelector("td label").textContent.toLowerCase();e.classList[n.includes(t)?"remove":"add"]("visually-hidden")})),e.refreshStatus()}));!function(){const t=e.querySelector("#"+r),n=e.querySelector("#"+r+"-button");t.querySelectorAll(".dropdown-item").forEach((e=>{e.addEventListener("click",(e=>{!function(e){const t=F(e,"attr"),r=F(e,"comp-type","string"),s=F(e,"dir","asc"),a=F(e,"icon"),i=F(e,"title");n.innerHTML=`<b2d-icon name="${a}"></b2d-icon>`,n.setAttribute("title",i),((e,t="asc",n="string")=>{const r=Array.from(o.rows).slice(1),s="int"===n;r.sort(((n,r)=>{let a=n.getAttribute(e),o=r.getAttribute(e);return s?(a=parseInt(a),o=parseInt(o),"asc"===t?a-o:o-a):"asc"===t?a.localeCompare(o):o.localeCompare(a)})),r.forEach((e=>o.tBodies[0].appendChild(e)))})(t,s,r)}(e.target)}))}))}(),e.querySelector("#clear-search-button").addEventListener("click",(()=>{e.setSearchValue("").refreshSearchStatus(),e.searchInput.focus()}))}refreshStatus(){return this.updateButtonsState().refreshItemsStatus(),this}refreshItemsStatus(){const e=this;return e.statusElements.forEach((t=>{const n=e.querySelectorAll("tr.release-item").length,r=e.getSelectedValues().length,s=e.querySelectorAll("tr.release-item:not(.visually-hidden)").length,a=t.getAttribute("data-format").replace(new RegExp("{total}","g"),n).replace(new RegExp("{selected}","g"),r).replace(new RegExp("{filtered}","g"),s);t.textContent=a})),e}refreshSearchStatus(){return Z(this.searchInput),this}addStatusElement(...e){const t=this;return e.forEach((e=>t.statusElements.push(e))),t}getPrefix(){return this.id}getPrefixed(e){return this.getPrefix()+"__"+e??""}appendButton(...e){const t=this.querySelector(".control-buttons");return e.forEach((e=>t.appendChild(e))),this}addStateButton(...e){const t=this;return e.forEach((e=>t.stateButtons.push(e))),t}selectCheckbox(e,t){if("checkbox"!==e.type)return this;if(e.checked=t,e.classList.contains("release-checkbox")){const t=e.closest("tr"),n="table-active";e.checked?t.classList.add(n):t.classList.remove(n)}return this}connectedCallback(){const e=this.getAttribute("data"),t=e?JSON.parse(e):[];y(t)||this.populateData(t)}populateData(e){const t=this,n=t.querySelector("tbody");return n.innerHTML="",e.forEach(((e,r)=>{const s=document.createElement("tr"),a=t.getPrefixed("checkbox_"+r);s.classList.add("release-item"),V(s,"sort",r),V(s,e.dataAtts),s.innerHTML=`\n        <td><input type="checkbox" value="${e.value}" id="${a}" class="release-checkbox"></td>\n        <td><label for="${a}">${e.title}</label><span class="controls"></span></td>\n      `;const o=s.querySelector("span.controls");e.controls.forEach((e=>{e instanceof HTMLElement&&o.appendChild(e)})),n.appendChild(s)})),t.refreshStatus().refreshSearchStatus(),t}selectAllCheckboxes(e){const t=this;return t.getCheckboxes().forEach((n=>{t.selectCheckbox(n,e)})),t}getCheckboxes(e=!1){return this.querySelectorAll(".release-item:not(.visually-hidden) input.release-checkbox[type='checkbox']"+(e?":checked":""))}getSelectedValues(){return Array.from(this.getCheckboxes(!0)).map((e=>e.value))}getSelectedTitles(){return Array.from(this.getCheckboxes(!0)).map((e=>e.nextElementSibling.textContent))}updateButtonState(e){const t=this.getCheckboxes(),n=Array.from(t).some((e=>e.checked));return e.disabled=!n,this}updateButtonsState(){const e=this;return e.querySelectorAll("[data-status-update]").forEach((t=>e.updateButtonState(t))),e.stateButtons.forEach((t=>e.updateButtonState(t))),e}setSearchValue(e){return this.searchInput.value=e,this}}function ne(e){if(!e||0===e.length)return"";const t=Object.keys(e[0]),n=[t.join(",")];for(const r of e){const e=t.map((e=>r[e]));n.push(e.join(","))}return n.join("\n")}function re(e,t){const n=new Blob([e],{type:"text/csv"}),r=URL.createObjectURL(n),s=document.createElement("a");var a,o;s.href=r,s.download=`${a=t,(o=a,Array.from(o).map((e=>h[e]||e)).join("")).replace(/[^a-zA-Z0-9]/gi,"_").toLowerCase()}.csv`,s.click(),URL.revokeObjectURL(r)}customElements.get("releases-list")||customElements.define("releases-list",te);const se=chrome.storage.local;function ae(e,t){const n=function(e){const t=[];return e.forEach((e=>t.push(o(e)))),t}(e);se.get(n,(e=>{let n=Object.values(e).map((function(e){try{return u.fromStorageObject(e)}catch(t){return console.log("B2D: Broken storage object. "+JSON.stringify(t),e),null}})).filter((e=>e instanceof u));b(t)&&t(n)}))}function oe(e,t){g(e)?e.forEach((e=>oe(e,t))):se.remove(e,(()=>{chrome.runtime.lastError&&console.error(`Error clearing local storage item with key "${e}": ${chrome.runtime.lastError}`),b(t)&&t()}))}function ie(e){if(!p(e)&&!g(e))return document.createTextNode(e);const t=document.createElement("table");t.classList.add("table","table-sm","table-striped","table-bordered");for(const[n,r]of Object.entries(e)){const e=document.createElement("tr"),s=document.createElement("th"),a=document.createElement("td");s.classList.add("w-25"),a.classList.add("w-auto"),s.textContent=n,p(r)?a.appendChild(ie(r)):g(r)?a.innerHTML=r.map((e=>f(e)?e:ie(e).outerHTML)).join(", "):a.innerHTML=f(r)?r.replace(/[\r\n]+/g,"<br/>"):r,e.appendChild(s),e.appendChild(a),t.appendChild(e)}return t}function ce(e,t){e.populateData(function(e){const t=[];return e.forEach((e=>{const n=e instanceof u?e.releaseItem:e,r=[ee({href:n.url,iconDefault:"box-arrow-up-right",className:"link-bandcamp-url",title:"View bandcamp release"}),ee({href:U(n.artist,n.title),iconDefault:"search",className:"link-discogs-search",title:"Search release on Discogs"})];if(e instanceof u){const t=ee({title:"Load release hints into the current Discogs release draft",iconDefault:"file-arrow-down",iconOnClick:"file-arrow-down-fill",onClick:()=>{const t=P.fromRelease(e);return C({type:"metadata",metadata:t}),!0}});r.push(t)}var s,a;t.push({title:`${n.artist} - ${n.title}`,value:(a=n,o(a.url)),id:(s=n.title,s.toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-+|-+$/g,"")),dataAtts:{title:`${n.artist} - ${n.title}`},controls:r})})),t}(t))}function le(e,t){!e instanceof HTMLElement||(e.style.backgroundImage=`url(${t})`)}function ue(e){return Y(e),V(e,"original-content",e.innerHTML),e.innerHTML='\n  <span class="spinner-border spinner-border-sm" aria-hidden="true"></span>\n  <span class="visually-hidden" role="status">Loading...</span>\n',e}function de(e){return J(e),z(e,"original-content")&&(e.innerHTML=F(e,"original-content")),e}function he(e,t){const n=me();z(e,"buttons-initialized")||(function(e,t,n){const r=X('\n<button id="historyDataClearSelected" type="button" class="btn btn-danger" data-status-update title="Clear selected history">\n  <b2d-icon name="database-dash"></b2d-icon>\n</button>'),s=X('\n<button id="historyDataClear" type="button" class="btn btn-dark" title="Remove all items from the history" data-bs-toggle="modal" data-bs-target="#historyTabDeleteAllModal">\n  <b2d-icon name="database-x"></b2d-icon>\n</button>');n.addEventListener("click",(e=>{const n=e.target;ue(n);const r=t.querySelectorAll(".release-item.table-active .link-bandcamp-url");ae(Array.from(r).map((e=>e.getAttribute("href"))),(e=>{const t=e[0];re(ne(e.map((e=>N.fromRelease(e).toCsvObject()))),`discogs-selected-releases-${t.artist}`),de(n)}))})),t.addStateButton(n),r.addEventListener("click",(()=>{oe(t.getSelectedValues(),(()=>{fe(t)}))})),e.querySelector("#historyTabDeleteAllModal_btnYes").addEventListener("click",(()=>{se.clear(),fe(t)})),t.appendButton(r,s),t.addStatusElement(document.getElementById("selectedStatusInfo"),document.getElementById("viewedStatusInfo"))}(e,n,t),V(e,"buttons-initialized")),x(O.genres_url).then((e=>{$(O.keyword_mapping_url).then((e=>{fe(n)}))}))}function me(){return document.getElementById("historyReleasesList")}function fe(e){var t;t=t=>{ce(e,t)},se.get(null,(e=>{const n=[];for(const t in e)if(e.hasOwnProperty(t)||p(e[t]))try{n.push(u.fromStorageObject(e[t]))}catch(e){continue}b(t)&&t(n)}))}function pe(e){if(y(e))return;const t=e[0];re(ne(e.map((e=>N.fromRelease(e).toCsvObject()))),e.length>1?`discogs-selected-releases-${t.artist}`:`discogs-releases-${t.artist}-${t.title}`)}function ge(){setTimeout((()=>window.close()),1e3)}function be(e){let t=e.offsetHeight,n=parseInt(getComputedStyle(e).lineHeight);return Math.round(t/n)}function ye(e,t){t.addEventListener("click",(()=>{const t=document.getElementById("csvData");t.innerHTML="",e instanceof u&&function(e,t,n){const r=document.createElement("h2");r.classList.add("display-6"),r.innerText="Discogs CSV data",n.appendChild(r),n.appendChild(ie(t))}(0,H(e).toCsvObject(),t)}))}const Se=!("update_url"in chrome.runtime.getManifest()),we=(...e)=>{if(!Se)return;const t=(new Date).toISOString();console.log(`[B2D][DEBUG] ${t}:`,...e)},ke=(...e)=>{if(!Se)return;const t=(new Date).toISOString();console.info(`[B2D][INFO] ${t}:`,...e)};function ve(e){ke("Init console");const t=setInterval((()=>{const n=document.querySelector("console-command");n&&(e(n),ke("Console initialized"),clearInterval(t))}),100)}const Ee=document.getElementById("dashboard-tab"),Ie=document.getElementById("release-tab"),Ce=document.getElementById("releases-tab"),Le=document.getElementById("csvData-tab"),xe=document.getElementById("history-tab"),Ae=document.getElementById("downloadRelease"),Be=document.getElementById("downloadReleases"),De=document.getElementById("downloadHistory"),Me=document.getElementById("discogsSearchArtist"),$e=document.getElementById("releases");async function Oe(){ke("Proceed bandcamp data"),E().then((e=>{chrome.tabs.sendMessage(e.id,{type:"getBandcampData"},(e=>{null!=e&&0!==Object.keys(e).length&&void 0!==e.data?function(e){const t="release"===e.type,n="list"===e.type;(t||n)&&x(O.genres_url).then((n=>{$(O.keyword_mapping_url).then((n=>{t?function(e,t){Q(Ce),G(Ie),K(Ie);try{const n=u.fromStorageObject(e);!function(e,t){ve((n=>{n.addCommand("log.release",(()=>{we("Release:",e)})),n.addCommand("log.keywordsMapping",(()=>{we("Keywords mapping:",t)}));const r=H(e);n.addCommand("log.discogsCsv",(()=>{we("Discogs CSV:",r)}));const s=P.fromRelease(e);n.addCommand("log.metadata",(()=>{we("Release metadata:",s)}))}))}(n,t),function(e,t,n,r){var s,a;!function(e,t){const n=e.querySelector("#release-artist"),r=e.querySelector("#release-title"),s=e.querySelector("#release-year"),a=(e.querySelector(".release-content"),e.querySelector("#release-tracks"));le(document.querySelector(".bg-image"),t.image),n.innerHTML=t.releaseItem.artist,r.innerHTML=t.releaseItem.title,s.innerHTML=t.published.getFullYear();let o=be(n),i=be(r);n.classList.toggle("display-6",o>=3&&o<=5),e.classList.add("lines-a"+o+"-t"+i);const c=t.tracks.map((e=>`${e.num}. ${m(e.title)} (${v(e.time.value)})`)).join("<br>");a.innerHTML=c}(e,t),r.href=U(t.releaseItem.artist,t.releaseItem.title),s=n,y(a=[t])?Y(s):(J(s),s.addEventListener("click",(()=>pe(a))))}(document.getElementById("release"),n,Ae,Me),ye(n,Le)}catch(e){console.error(e)}}(e.data,n):function(e){Q(Ie),G(Ce),K(Ce),function(e,t,n,r,s){le(document.querySelector(".bg-image"),n);const a=e.querySelector("#releasesTabLIst");s.addEventListener("click",(async e=>{const t=e.target;ue(t);const n=a.querySelectorAll(".release-item.table-active .link-bandcamp-url"),r=Array.from(n).map((e=>e.getAttribute("href")));(async function(e,t){const n=[];for(const r of e){const e=new Promise((e=>{chrome.tabs.create({url:r,active:!1},(n=>{t&&t(n),e(n)}))}));n.push(e)}return Promise.all(n)})(r,(e=>{chrome.scripting.executeScript({target:{tabId:e.id},func:ge}).then((()=>{}))})).then((()=>{setTimeout((()=>{ae(r,(e=>{pe(e),de(t)}))}),3e3)}))})),a.addStateButton(s).addStatusElement(document.getElementById("selectedStatusInfo"),document.getElementById("viewedStatusInfo"));const o=[];let i;function c(e,t){chrome.tabs.sendMessage(e.id,{type:"releases-list-search",search:t})}t.forEach((e=>o.push(l.fromObject(e)))),ce(a,o),a.searchInput.addEventListener("input",(()=>{const e=a.searchInput.value;i?c(i,e):E().then((t=>{i=t,c(i,e)}))})),Z(a.searchInput,r)}($e,e.data,e.popup.imageSrc,e.popup.search,Be)}(e)}))}))}(e):Te()}))}))}function Te(){Y(Ie,Le),Q(Ce),G(Be),K(Ee);const e=setInterval((()=>{const t=document.getElementById("b2d-warning-bandcamp-data-not-found");t&&(G(t),clearInterval(e))}),100)}function je(e){ke("Replace extension version");const t=I();e.querySelectorAll(".version").forEach((e=>{e.textContent=t.version}))}function qe(e){const t=e.url;var n,r;ke("Popup initialization"),ke("Current URL",t),ve((e=>{e.addCommand("log.storage",(()=>{console.log("B2D: Storage data"),se.get(null,(e=>console.log(e)))}))})),ke("Setup navigation"),Ie.addEventListener("click",(()=>{Q(Be,De),G(Ae),J(Le)})),Ce.addEventListener("click",(()=>{Q(Ae,De),G(Be),Y(Le),$e.querySelector("releases-list").refreshStatus()})),xe.addEventListener("click",(()=>{Q(Ae,Be),G(De),he(document.getElementById("history"),De)})),je(document),ke("Check storage size"),n=e=>{document.querySelectorAll(".storage-size").forEach((t=>{t.textContent=function(e){if(0===e)return"0 Byte";const t=parseInt(Math.floor(Math.log(e)/Math.log(1024)));return Math.round(e/Math.pow(1024,t),2)+" "+["Bytes","KB","MB","GB","TB"][t]}(e),t.setAttribute("title",`Storage size (${e} bytes)`)}))},se.getBytesInUse(null,n),r=e=>{je(e.target)},document.querySelectorAll("external-content").forEach((e=>{e.addEventListener("externalContentLoaded",r)})),t.includes("bandcamp.com")?Oe():t.includes("www.discogs.com/release/edit/")?async function(){ke("Proceed discogs edit page data"),E().then((e=>{chrome.tabs.sendMessage(e.id,{type:"getDiscogsEditPageData"},(e=>{null!=e&&0!==Object.keys(e).length&&void 0!==e.data&&function(e){var t;Y(Ie,Le),Q(Ce),K(xe),t=e.data.artistName,me().setSearchValue(t)}(e)}))}))}():Te()}document.addEventListener("DOMContentLoaded",(()=>{E().then((e=>{qe(e)}))}))})();
//# sourceMappingURL=popup.js.map